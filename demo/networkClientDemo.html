<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´ç½‘ç»œå¯¹æˆ˜å®¢æˆ·ç«¯ - Task 2.4</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
        }

        .status-card h3 {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .status-card p {
            font-size: 18px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .side-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .side-panel h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .canvas-container {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 100%;
            height: auto;
        }

        .info-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .log-container {
            background: white;
            padding: 10px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }

        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #667eea;
            padding-left: 8px;
        }

        .log-entry.success { border-left-color: #43e97b; }
        .log-entry.error { border-left-color: #ff6b6b; }
        .log-entry.warning { border-left-color: #f093fb; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff6b6b;
            margin-right: 8px;
        }

        .connection-indicator.connected {
            background: #43e97b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® å®Œæ•´ç½‘ç»œå¯¹æˆ˜å®¢æˆ·ç«¯</h1>
        <p class="subtitle">Task 2.4 - é›†æˆç½‘ç»œå¯¹æˆ˜ç³»ç»Ÿä¸BattleManager</p>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-card">
                <h3>è¿æ¥çŠ¶æ€</h3>
                <p>
                    <span class="connection-indicator" id="connIndicator"></span>
                    <span id="connStatus">æœªè¿æ¥</span>
                </p>
            </div>
            <div class="status-card">
                <h3>å¯¹æˆ˜çŠ¶æ€</h3>
                <p id="battleStatus">ç­‰å¾…ä¸­...</p>
            </div>
            <div class="status-card">
                <h3>å»¶è¿Ÿ</h3>
                <p><span id="latency">--</span>ms</p>
            </div>
            <div class="status-card">
                <h3>æˆ¿é—´ID</h3>
                <p id="roomId">--</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button id="btnConnect" class="btn-success">è¿æ¥æœåŠ¡å™¨</button>
            <button id="btnCreate" class="btn-primary" disabled>åˆ›å»ºæˆ¿é—´</button>
            <button id="btnJoin" class="btn-info" disabled>åŠ å…¥æˆ¿é—´</button>
            <button id="btnMatch" class="btn-warning" disabled>éšæœºåŒ¹é…</button>
            <button id="btnLeave" class="btn-danger" disabled>ç¦»å¼€æˆ¿é—´</button>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Panel -->
            <div class="side-panel">
                <h3>ç©å®¶ä¿¡æ¯</h3>
                <div class="info-item">
                    <label>ç©å®¶ID</label>
                    <div class="value" id="playerId">--</div>
                </div>
                <div class="info-item">
                    <label>è§’è‰²</label>
                    <div class="value" id="playerRole">--</div>
                </div>
                <div class="info-item">
                    <label>åˆ†æ•°</label>
                    <div class="value" id="playerScore">0</div>
                </div>
                <div class="info-item">
                    <label>ç§»åŠ¨æ¬¡æ•°</label>
                    <div class="value" id="playerMoves">0</div>
                </div>
            </div>

            <!-- Center - Canvas -->
            <div class="canvas-container">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
            </div>

            <!-- Right Panel -->
            <div class="side-panel">
                <h3>å¯¹æ‰‹ä¿¡æ¯</h3>
                <div class="info-item">
                    <label>å¯¹æ‰‹ID</label>
                    <div class="value" id="opponentId">--</div>
                </div>
                <div class="info-item">
                    <label>çŠ¶æ€</label>
                    <div class="value" id="opponentStatus">ç­‰å¾…ä¸­</div>
                </div>
                <div class="info-item">
                    <label>åˆ†æ•°</label>
                    <div class="value" id="opponentScore">0</div>
                </div>
                <div class="info-item">
                    <label>ç§»åŠ¨æ¬¡æ•°</label>
                    <div class="value" id="opponentMoves">0</div>
                </div>
            </div>
        </div>

        <!-- Log Container -->
        <div class="side-panel">
            <h3>äº‹ä»¶æ—¥å¿—</h3>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <!-- Join Room Modal -->
    <div class="modal" id="joinModal">
        <div class="modal-content">
            <h2>åŠ å…¥æˆ¿é—´</h2>
            <input type="text" id="roomIdInput" placeholder="è¾“å…¥æˆ¿é—´ID">
            <div class="modal-actions">
                <button class="btn-info" id="btnConfirmJoin">åŠ å…¥</button>
                <button class="btn-danger" id="btnCancelJoin">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { NetworkBattleManager, NetworkBattleState, NetworkPlayerRole } from '../dist/NetworkBattleManager.js';
        import { GameUI } from '../dist/GameUI.js';
        import { MatchmakingMode } from '../dist/MatchmakingSystem.js';

        // WebSocket URL (auto-detect environment)
        const WS_URL = window.location.hostname === 'localhost'
            ? 'ws://localhost:8080'
            : 'wss://8080-iktgs51wmt9svcuxtee4x-b32ec7bb.sandbox.novita.ai';

        let networkBattle = null;
        let gameUI = null;

        // UI Elements
        const connIndicator = document.getElementById('connIndicator');
        const connStatus = document.getElementById('connStatus');
        const battleStatus = document.getElementById('battleStatus');
        const latency = document.getElementById('latency');
        const roomId = document.getElementById('roomId');
        const playerId = document.getElementById('playerId');
        const playerRole = document.getElementById('playerRole');
        const playerScore = document.getElementById('playerScore');
        const playerMoves = document.getElementById('playerMoves');
        const opponentId = document.getElementById('opponentId');
        const opponentStatus = document.getElementById('opponentStatus');
        const opponentScore = document.getElementById('opponentScore');
        const opponentMoves = document.getElementById('opponentMoves');
        const logContainer = document.getElementById('logContainer');

        const btnConnect = document.getElementById('btnConnect');
        const btnCreate = document.getElementById('btnCreate');
        const btnJoin = document.getElementById('btnJoin');
        const btnMatch = document.getElementById('btnMatch');
        const btnLeave = document.getElementById('btnLeave');

        const joinModal = document.getElementById('joinModal');

        // Initialize
        function init() {
            addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            btnConnect.addEventListener('click', handleConnect);
            btnCreate.addEventListener('click', handleCreateRoom);
            btnJoin.addEventListener('click', () => joinModal.classList.add('active'));
            btnMatch.addEventListener('click', handleRandomMatch);
            btnLeave.addEventListener('click', handleLeave);

            document.getElementById('btnConfirmJoin').addEventListener('click', handleConfirmJoin);
            document.getElementById('btnCancelJoin').addEventListener('click', () => joinModal.classList.remove('active'));
        }

        // Connect to server
        async function handleConnect() {
            try {
                btnConnect.disabled = true;
                btnConnect.textContent = 'è¿æ¥ä¸­...';

                networkBattle = new NetworkBattleManager({ serverUrl: WS_URL });
                
                // Setup callbacks
                networkBattle.onStateChange(handleStateChange);
                networkBattle.onOpponentMove(handleOpponentMove);
                networkBattle.onBattleStart(handleBattleStart);
                networkBattle.onBattleEnd(handleBattleEnd);
                networkBattle.onError(handleError);

                await networkBattle.connect();
                
                playerId.textContent = networkBattle.getNetworkManager().getPlayerId();
                addLog('å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success');
                
                btnCreate.disabled = false;
                btnJoin.disabled = false;
                btnMatch.disabled = false;

                startLatencyMonitor();
            } catch (error) {
                addLog(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                btnConnect.disabled = false;
                btnConnect.textContent = 'è¿æ¥æœåŠ¡å™¨';
            }
        }

        // Create room
        async function handleCreateRoom() {
            try {
                btnCreate.disabled = true;
                const id = await networkBattle.createRoom();
                roomId.textContent = id;
                addLog(`æˆ¿é—´å·²åˆ›å»º: ${id}`, 'success');
                btnLeave.disabled = false;
            } catch (error) {
                addLog(`åˆ›å»ºæˆ¿é—´å¤±è´¥: ${error.message}`, 'error');
                btnCreate.disabled = false;
            }
        }

        // Join room
        async function handleConfirmJoin() {
            const id = document.getElementById('roomIdInput').value.trim();
            if (!id) return;

            try {
                await networkBattle.joinRoom(id);
                roomId.textContent = id;
                joinModal.classList.remove('active');
                addLog(`å·²åŠ å…¥æˆ¿é—´: ${id}`, 'success');
                btnLeave.disabled = false;
            } catch (error) {
                addLog(`åŠ å…¥æˆ¿é—´å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // Random match
        async function handleRandomMatch() {
            try {
                btnMatch.disabled = true;
                battleStatus.textContent = 'åŒ¹é…ä¸­...';
                addLog('å¼€å§‹éšæœºåŒ¹é…...', 'warning');
                
                await networkBattle.findMatch(MatchmakingMode.RANDOM);
                roomId.textContent = networkBattle.getRoomId();
                addLog('åŒ¹é…æˆåŠŸ!', 'success');
                btnLeave.disabled = false;
            } catch (error) {
                addLog(`åŒ¹é…å¤±è´¥: ${error.message}`, 'error');
                btnMatch.disabled = false;
                battleStatus.textContent = 'ç­‰å¾…ä¸­...';
            }
        }

        // Leave room
        function handleLeave() {
            networkBattle.leaveRoom();
            roomId.textContent = '--';
            opponentId.textContent = '--';
            playerRole.textContent = '--';
            btnLeave.disabled = true;
            btnCreate.disabled = false;
            btnMatch.disabled = false;
            addLog('å·²ç¦»å¼€æˆ¿é—´', 'warning');
        }

        // State change handler
        function handleStateChange(state) {
            battleStatus.textContent = getStateText(state);
            
            if (state === NetworkBattleState.CONNECTED) {
                connIndicator.classList.add('connected');
                connStatus.textContent = 'å·²è¿æ¥';
            } else if (state === NetworkBattleState.DISCONNECTED) {
                connIndicator.classList.remove('connected');
                connStatus.textContent = 'æœªè¿æ¥';
            }
            
            if (state === NetworkBattleState.IN_BATTLE) {
                initGameUI();
            }
        }

        // Opponent move handler
        function handleOpponentMove(move) {
            addLog(`å¯¹æ‰‹ç§»åŠ¨: (${move.pos1.row},${move.pos1.col}) â†” (${move.pos2.row},${move.pos2.col})`, 'warning');
            updateGameState();
        }

        // Battle start handler
        function handleBattleStart() {
            addLog('å¯¹æˆ˜å¼€å§‹!', 'success');
            opponentId.textContent = networkBattle.getOpponentId() || 'Unknown';
            playerRole.textContent = getRoleText(networkBattle.getPlayerRole());
            opponentStatus.textContent = 'å·²å°±ç»ª';
        }

        // Battle end handler
        function handleBattleEnd(winner) {
            addLog(`å¯¹æˆ˜ç»“æŸ! èƒœè€…: ${winner}`, 'success');
        }

        // Error handler
        function handleError(error) {
            addLog(`é”™è¯¯: ${error.message}`, 'error');
        }

        // Initialize game UI
        function initGameUI() {
            if (!gameUI) {
                gameUI = new GameUI({
                    canvasId: 'gameCanvas',
                    width: 800,
                    height: 600,
                    cellSize: 40
                });
                
                const battleManager = networkBattle.getBattleManager();
                gameUI.bindBattleManager(battleManager);
                
                addLog('æ¸¸æˆUIå·²åˆå§‹åŒ–', 'success');
            }
            
            updateGameState();
        }

        // Update game state
        function updateGameState() {
            if (!networkBattle || !networkBattle.isInBattle()) return;
            
            const battleManager = networkBattle.getBattleManager();
            const playerData = battleManager.getPlayerData();
            const opponentData = battleManager.getOpponentData();
            
            playerScore.textContent = playerData.score;
            playerMoves.textContent = playerData.moves;
            opponentScore.textContent = opponentData.score;
            opponentMoves.textContent = opponentData.moves;
            
            if (gameUI) {
                gameUI.updateStateFromBattle(battleManager);
            }
        }

        // Start latency monitor
        function startLatencyMonitor() {
            setInterval(() => {
                if (networkBattle && networkBattle.isConnected()) {
                    latency.textContent = networkBattle.getLatency();
                }
            }, 1000);
        }

        // Helper functions
        function getStateText(state) {
            const texts = {
                DISCONNECTED: 'æœªè¿æ¥',
                CONNECTING: 'è¿æ¥ä¸­',
                CONNECTED: 'å·²è¿æ¥',
                IN_LOBBY: 'å¤§å…ä¸­',
                IN_ROOM: 'æˆ¿é—´ä¸­',
                IN_BATTLE: 'å¯¹æˆ˜ä¸­',
                RECONNECTING: 'é‡è¿ä¸­',
                ERROR: 'é”™è¯¯'
            };
            return texts[state] || state;
        }

        function getRoleText(role) {
            const texts = {
                HOST: 'æˆ¿ä¸»',
                GUEST: 'å®¢äºº',
                UNKNOWN: 'æœªçŸ¥'
            };
            return texts[role] || role;
        }

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
