# ç¬¬ä¸€é˜¶æ®µé›†æˆæ¶æ„æ–‡æ¡£

## ğŸ¯ é›†æˆç›®æ ‡

å°†äº‹ä»¶ç³»ç»Ÿæ ¸å¿ƒæ¡†æ¶ä¸ä¸‰æ¶ˆå¯¹æˆ˜ç©æ³•æ·±åº¦æ•´åˆï¼Œå®ç°å®Œæ•´çš„æ¸¸æˆé€»è¾‘æµç¨‹ã€‚

---

## ğŸ“ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸‰æ¶ˆå¯¹æˆ˜æ¸¸æˆç³»ç»Ÿ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                        â”‚
                â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   BattleManager     â”‚    â”‚   GameManager    â”‚
    â”‚   (å¯¹æˆ˜ç®¡ç†å™¨)      â”‚    â”‚   (äº‹ä»¶ç®¡ç†å™¨)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                          â”‚
               â”‚ åŒ…å«                     â”‚ åŒ…å«
               â–¼                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   GridSystem x 2    â”‚    â”‚    EventBar      â”‚
    â”‚  (ç©å®¶+å¯¹æ‰‹ç½‘æ ¼)    â”‚    â”‚   (äº‹ä»¶æ¡)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                          â”‚
               â”‚                          â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   æ¸¸æˆé€»è¾‘è”åŠ¨
          (åˆ†æ•°æ¨è¿›äº‹ä»¶ï¼Œäº‹ä»¶å½±å“ç½‘æ ¼)
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. GridSystem (ä¸‰æ¶ˆç½‘æ ¼ç³»ç»Ÿ)

**èŒè´£**: ç®¡ç†å•ä¸ªç©å®¶çš„ä¸‰æ¶ˆæ£‹ç›˜é€»è¾‘

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… 8x8 ç½‘æ ¼ç®¡ç†
- âœ… 5 ç§ç³–æœç±»å‹ (çº¢ã€è“ã€ç»¿ã€é»„ã€ç´«)
- âœ… äº¤æ¢éªŒè¯å’ŒåŒ¹é…æ£€æµ‹
- âœ… é‡åŠ›æ‰è½å’Œå¡«å……
- âœ… è¿é”ååº”å¤„ç†
- âœ… äº‹ä»¶æ•ˆæœæ¥å£ (é‡åŠ›åè½¬ã€é¢œè‰²å†»ç»“ã€éšœç¢ç‰©ç”Ÿæˆ)

**å…³é”®æ–¹æ³•**:
```typescript
swap(pos1, pos2): SwapResult           // äº¤æ¢ç³–æœ
findAllMatches(): MatchResult[]        // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…
applyGravity(): void                   // åº”ç”¨é‡åŠ›
freezeColors(types): void              // å†»ç»“é¢œè‰²ï¼ˆäº‹ä»¶æ•ˆæœï¼‰
setGravityReversed(reversed): void    // é‡åŠ›åè½¬ï¼ˆäº‹ä»¶æ•ˆæœï¼‰
generateObstacles(count): Position[]   // ç”Ÿæˆéšœç¢ç‰©ï¼ˆäº‹ä»¶æ•ˆæœï¼‰
```

**æ–‡ä»¶**: `src/GridSystem.ts` (400+ è¡Œ)

---

### 2. BattleManager (å¯¹æˆ˜ç®¡ç†å™¨)

**èŒè´£**: æ•´åˆäº‹ä»¶ç³»ç»Ÿä¸åŒäººå¯¹æˆ˜é€»è¾‘

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… é›†æˆ GameManager äº‹ä»¶ç³»ç»Ÿ
- âœ… ç®¡ç†ç©å®¶å’Œå¯¹æ‰‹çš„ GridSystem
- âœ… å›åˆåˆ¶å¯¹æˆ˜æµç¨‹
- âœ… åˆ†æ•°è®¡ç®—ä¸äº‹ä»¶æ¨è¿›è”åŠ¨
- âœ… äº‹ä»¶æ•ˆæœåˆ°ç½‘æ ¼çš„è‡ªåŠ¨åº”ç”¨
- âœ… å¯¹æˆ˜èƒœè´Ÿåˆ¤å®š

**å…³é”®æ–¹æ³•**:
```typescript
startBattle(): void                    // å¼€å§‹å¯¹æˆ˜
playerTurn(pos1, pos2): TurnResult    // ç©å®¶å›åˆ
opponentTurn(pos1, pos2): TurnResult  // å¯¹æ‰‹å›åˆ
getBattleSummary(): string            // è·å–å¯¹æˆ˜æ‘˜è¦
```

**äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ**:
```typescript
// é‡åŠ›åè½¬äº‹ä»¶
gameManager.onEvent(GameEventType.GRAVITY_REVERSE, () => {
  player.grid.setGravityReversed(true);
  opponent.grid.setGravityReversed(true);
});

// å†»ç»“é¢œè‰²äº‹ä»¶
gameManager.onEvent(GameEventType.FROZEN_COLORS, () => {
  const frozenColors = selectRandomColors(1-2);
  player.grid.freezeColors(frozenColors);
  opponent.grid.freezeColors(frozenColors);
});

// è¿å‡»åŠ æˆäº‹ä»¶
gameManager.onEvent(GameEventType.COMBO_BONUS, () => {
  // åœ¨è®¡åˆ†æ—¶åˆ†æ•°ç¿»å€
});

// ç”Ÿæˆéšœç¢ç‰©äº‹ä»¶
gameManager.onEvent(GameEventType.OBSTACLE_GENERATE, () => {
  opponent.grid.generateObstacles(2-4);
});
```

**æ–‡ä»¶**: `src/BattleManager.ts` (400+ è¡Œ)

---

## ğŸ”„ æ•°æ®æµè¯¦è§£

### ç©å®¶æ“ä½œ â†’ äº‹ä»¶è§¦å‘å®Œæ•´æµç¨‹

```
1. ç©å®¶æ“ä½œ
   â†“
   playerTurn(pos1, pos2)
   
2. ç½‘æ ¼å¤„ç†
   â†“
   GridSystem.swap()
   â”œâ”€ éªŒè¯äº¤æ¢æœ‰æ•ˆæ€§
   â”œâ”€ æ‰§è¡Œäº¤æ¢
   â”œâ”€ æŸ¥æ‰¾åŒ¹é…
   â””â”€ å¤„ç†è¿é”ååº”
   
3. åˆ†æ•°è®¡ç®—
   â†“
   åŸºç¡€åˆ†æ•° = åŒ¹é…é•¿åº¦ Ã— 10 Ã— è¿å‡»å€æ•°
   å¦‚æœè¿å‡»åŠ æˆäº‹ä»¶æ´»è·ƒ:
     æœ€ç»ˆåˆ†æ•° = åŸºç¡€åˆ†æ•° Ã— 2
   
4. æ¨è¿›äº‹ä»¶ç³»ç»Ÿ
   â†“
   GameManager.addScore(æœ€ç»ˆåˆ†æ•°)
   â”œâ”€ EventBar.advanceProgress(åˆ†æ•°)
   â”œâ”€ æ£€æŸ¥æ˜¯å¦è¾¾åˆ°äº‹ä»¶é˜ˆå€¼
   â””â”€ å¦‚æœè¾¾åˆ°ï¼Œè§¦å‘äº‹ä»¶
   
5. äº‹ä»¶æ•ˆæœåº”ç”¨
   â†“
   onEventTriggered(eventType)
   â”œâ”€ è°ƒç”¨äº‹ä»¶å¤„ç†æ–¹æ³•
   â”œâ”€ è§¦å‘æ³¨å†Œçš„å›è°ƒå‡½æ•°
   â””â”€ åº”ç”¨æ•ˆæœåˆ°åŒæ–¹ç½‘æ ¼
      â”œâ”€ é‡åŠ›åè½¬ â†’ setGravityReversed(true)
      â”œâ”€ å†»ç»“é¢œè‰² â†’ freezeColors([colors])
      â”œâ”€ ç”Ÿæˆéšœç¢ç‰© â†’ generateObstacles(count)
      â””â”€ è¿å‡»åŠ æˆ â†’ åœ¨è®¡åˆ†æ—¶ç”Ÿæ•ˆ
   
6. åˆ‡æ¢å›åˆ
   â†“
   currentTurn = OPPONENT
```

---

## ğŸ“Š äº‹ä»¶æ•ˆæœå®ç°ç»†èŠ‚

### 1. é‡åŠ›åè½¬ (GRAVITY_REVERSE)

**æ•ˆæœ**: ç³–æœä»å‘ä¸‹æ‰è½å˜ä¸ºå‘ä¸Šç§»åŠ¨

**å®ç°**:
```typescript
// GridSystem.ts
private applyGravity(): void {
  if (this.gravityReversed) {
    // å‘ä¸Šç§»åŠ¨ï¼šä»ä¸Šå¾€ä¸‹å†™å…¥
    for (let col = 0; col < this.cols; col++) {
      let writeRow = 0;
      for (let readRow = 0; readRow < this.rows; readRow++) {
        if (this.grid[readRow][col] !== EMPTY) {
          grid[writeRow][col] = grid[readRow][col];
          writeRow++;
        }
      }
    }
  } else {
    // æ­£å¸¸å‘ä¸‹ç§»åŠ¨
    // ...
  }
}
```

**æŒç»­æ—¶é—´**: 15ç§’

**å½±å“èŒƒå›´**: åŒæ–¹ç½‘æ ¼

---

### 2. å†»ç»“é¢œè‰² (FROZEN_COLORS)

**æ•ˆæœ**: 1-2ç§é¢œè‰²çš„ç³–æœæ— æ³•æ¶ˆé™¤

**å®ç°**:
```typescript
// GridSystem.ts
private findAllMatches(): MatchResult[] {
  // æ‰«ææ—¶è·³è¿‡å†»ç»“çš„é¢œè‰²
  if (candy === EMPTY || this.frozenTypes.has(candy)) {
    continue;
  }
  // ...
}

// BattleManager.ts
gameManager.onEvent(GameEventType.FROZEN_COLORS, () => {
  const frozenColors = selectRandomColors(1-2);
  player.grid.freezeColors(frozenColors);
  opponent.grid.freezeColors(frozenColors);
});
```

**æŒç»­æ—¶é—´**: 15ç§’

**å½±å“èŒƒå›´**: åŒæ–¹ç½‘æ ¼

---

### 3. è¿å‡»åŠ æˆ (COMBO_BONUS)

**æ•ˆæœ**: åˆ†æ•°ç¿»å€

**å®ç°**:
```typescript
// BattleManager.ts
let score = swapResult.score;
if (gameManager.isEventActive(GameEventType.COMBO_BONUS)) {
  score *= 2;  // åˆ†æ•°ç¿»å€
}
playerData.score += score;
```

**æŒç»­æ—¶é—´**: 15ç§’

**å½±å“èŒƒå›´**: åŒæ–¹å¾—åˆ†

---

### 4. ç”Ÿæˆéšœç¢ç‰© (OBSTACLE_GENERATE)

**æ•ˆæœ**: åœ¨å¯¹æ‰‹æ£‹ç›˜ç”Ÿæˆ2-4ä¸ªéšœç¢ç‰©

**å®ç°**:
```typescript
// GridSystem.ts
public generateObstacles(count: number): Position[] {
  const obstacles: Position[] = [];
  for (let i = 0; i < count; i++) {
    const randomPos = getRandomPosition();
    this.grid[randomPos.row][randomPos.col] = CandyType.EMPTY;
    obstacles.push(randomPos);
  }
  return obstacles;
}

// BattleManager.ts
gameManager.onEvent(GameEventType.OBSTACLE_GENERATE, () => {
  const count = Math.floor(Math.random() * 3) + 2; // 2-4ä¸ª
  opponent.grid.generateObstacles(count);
});
```

**æŒç»­æ—¶é—´**: ç«‹å³ç”Ÿæ•ˆï¼Œæ°¸ä¹…å­˜åœ¨

**å½±å“èŒƒå›´**: ä»…å¯¹æ‰‹ç½‘æ ¼

---

### 5. åŠ é€Ÿ (SPEED_UP)

**æ•ˆæœ**: æ¸¸æˆé€Ÿåº¦æå‡ï¼ˆä¸»è¦å½±å“UIåŠ¨ç”»ï¼‰

**å®ç°**: å‰ç«¯æ¸²æŸ“æ—¶è¯»å–äº‹ä»¶çŠ¶æ€è°ƒæ•´åŠ¨ç”»é€Ÿåº¦

**æŒç»­æ—¶é—´**: 15ç§’

**å½±å“èŒƒå›´**: UIåŠ¨ç”»

---

## ğŸ® å¯¹æˆ˜é…ç½®

```typescript
interface BattleConfig {
  maxMoves?: number;         // æœ€å¤§æ­¥æ•°ï¼ˆé»˜è®¤30ï¼‰
  targetScore?: number;      // ç›®æ ‡åˆ†æ•°ï¼ˆé»˜è®¤1000ï¼‰
  eventProgressMax?: number; // äº‹ä»¶è¿›åº¦æœ€å¤§å€¼ï¼ˆé»˜è®¤100ï¼‰
  gridSize?: { rows, cols }; // ç½‘æ ¼å°ºå¯¸ï¼ˆé»˜è®¤8x8ï¼‰
}
```

**ç¤ºä¾‹**:
```typescript
const battle = new BattleManager({
  maxMoves: 20,
  targetScore: 800,
  eventProgressMax: 80,
  gridSize: { rows: 8, cols: 8 }
});
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæ¼”ç¤º

```bash
# æ„å»ºé¡¹ç›®
npm run build

# è¿è¡Œå¯¹æˆ˜æ¼”ç¤º
npm run demo:battle

# è¿è¡Œå®Œæ•´æµ‹è¯•
npm test
```

### æµ‹è¯•è¦†ç›–

1. âœ… **GridSystem æµ‹è¯•**
   - ç½‘æ ¼åˆå§‹åŒ–
   - äº¤æ¢å’ŒåŒ¹é…æ£€æµ‹
   - é‡åŠ›æ‰è½å’Œè¿é”ååº”
   - äº‹ä»¶æ•ˆæœï¼ˆé‡åŠ›åè½¬ã€é¢œè‰²å†»ç»“ï¼‰

2. âœ… **BattleManager æµ‹è¯•**
   - å¯¹æˆ˜å¯åŠ¨å’Œæµç¨‹
   - åŒäººå›åˆåˆ¶
   - åˆ†æ•°è®¡ç®—å’Œäº‹ä»¶æ¨è¿›
   - äº‹ä»¶è§¦å‘å’Œæ•ˆæœåº”ç”¨

3. âœ… **é›†æˆæµ‹è¯•**
   - å®Œæ•´å¯¹æˆ˜æµç¨‹
   - äº‹ä»¶ç³»ç»Ÿä¸ç½‘æ ¼ç³»ç»ŸååŒ
   - å¤šæ¬¡äº‹ä»¶è§¦å‘

---

## ğŸ“ˆ æ€§èƒ½ç‰¹ç‚¹

### GridSystem
- **äº¤æ¢æ£€æµ‹**: O(1)
- **åŒ¹é…æŸ¥æ‰¾**: O(nÃ—m) - nÃ—m ä¸ºç½‘æ ¼å°ºå¯¸
- **é‡åŠ›æ‰è½**: O(nÃ—m)
- **è¿é”å¤„ç†**: O(kÃ—nÃ—m) - k ä¸ºè¿é”æ¬¡æ•°

### BattleManager
- **å›åˆå¤„ç†**: O(1)
- **äº‹ä»¶è§¦å‘**: O(1)
- **çŠ¶æ€æŸ¥è¯¢**: O(1)

### ä¼˜åŒ–å»ºè®®
- âœ… ä½¿ç”¨ Set å­˜å‚¨å†»ç»“é¢œè‰²ï¼ˆO(1) æŸ¥æ‰¾ï¼‰
- âœ… ä½¿ç”¨ Map å­˜å‚¨æ´»åŠ¨äº‹ä»¶ï¼ˆO(1) æŸ¥æ‰¾ï¼‰
- âœ… é¿å…ä¸å¿…è¦çš„ç½‘æ ¼å¤åˆ¶
- âœ… äº‹ä»¶å®šæ—¶å™¨è‡ªåŠ¨æ¸…ç†

---

## ğŸ”Œ æ‰©å±•æ¥å£

### ä¸º Phaser/Cocos é›†æˆé¢„ç•™çš„æ¥å£

```typescript
// 1. ç½‘æ ¼çŠ¶æ€æŸ¥è¯¢
GridSystem.getGrid(): CandyType[][]
GridSystem.getCandyAt(pos): CandyType
GridSystem.getSize(): { rows, cols }

// 2. äº‹ä»¶çŠ¶æ€æŸ¥è¯¢
BattleManager.getGameManager(): GameManager
GameManager.isEventActive(event): boolean
GameManager.getActiveEvents(): GameEventType[]

// 3. å›åˆæ§åˆ¶
BattleManager.playerTurn(pos1, pos2): TurnResult
BattleManager.getCurrentTurn(): PlayerType
BattleManager.isBattleActive(): boolean

// 4. æ•°æ®ç»‘å®š
BattleManager.getPlayerData(): PlayerData
BattleManager.getOpponentData(): PlayerData
```

**UI é›†æˆç¤ºä¾‹**:
```typescript
// åœ¨ Phaser ä¸­
class GameScene extends Phaser.Scene {
  private battle: BattleManager;
  
  create() {
    this.battle = new BattleManager();
    this.battle.startBattle();
    
    // æ³¨å†Œäº‹ä»¶ç›‘å¬
    this.battle.getGameManager().onEvent(
      GameEventType.GRAVITY_REVERSE,
      () => this.playGravityReverseAnimation()
    );
    
    // æ¸²æŸ“ç½‘æ ¼
    this.renderGrid(this.battle.getPlayerData().grid);
  }
  
  handleSwap(pos1, pos2) {
    const result = this.battle.playerTurn(pos1, pos2);
    if (result.success) {
      this.playMatchAnimation(result.swapResult.matches);
    }
  }
}
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è®¡åˆ’

### ç¬¬äºŒé˜¶æ®µï¼šUI é›†æˆ

1. **Phaser åœºæ™¯æ­å»º**
   - ç½‘æ ¼æ¸²æŸ“
   - ç³–æœåŠ¨ç”»
   - ç‰¹æ•ˆç³»ç»Ÿ

2. **äº¤äº’é€»è¾‘**
   - è§¦æ‘¸/ç‚¹å‡»æ£€æµ‹
   - æ»‘åŠ¨äº¤æ¢
   - æç¤ºç³»ç»Ÿ

3. **è§†è§‰åé¦ˆ**
   - åŒ¹é…åŠ¨ç”»
   - è¿å‡»ç‰¹æ•ˆ
   - äº‹ä»¶è§¦å‘æ•ˆæœ

### ç¬¬ä¸‰é˜¶æ®µï¼šç½‘ç»œå¯¹æˆ˜

1. **é€šä¿¡åè®®**
   - WebSocket è¿æ¥
   - å›åˆåŒæ­¥
   - çŠ¶æ€å¹¿æ’­

2. **åŒ¹é…ç³»ç»Ÿ**
   - æˆ¿é—´ç®¡ç†
   - ç©å®¶åŒ¹é…
   - æ–­çº¿é‡è¿

3. **å¾®ä¿¡å°ç¨‹åºé€‚é…**
   - äº‘å‡½æ•°åç«¯
   - æ•°æ®å­˜å‚¨
   - æ’è¡Œæ¦œç³»ç»Ÿ

---

## âœ… å½“å‰å®Œæˆæƒ…å†µ

### ä»£ç æ–‡ä»¶
- âœ… `src/GridSystem.ts` (400+ è¡Œ)
- âœ… `src/BattleManager.ts` (400+ è¡Œ)
- âœ… `src/battleDemo.ts` (æ¼”ç¤ºç¨‹åº)
- âœ… `src/battleIntegrationTest.ts` (é›†æˆæµ‹è¯•)

### æµ‹è¯•éªŒè¯
- âœ… ç½‘æ ¼ç³»ç»ŸåŠŸèƒ½æµ‹è¯•
- âœ… å¯¹æˆ˜ç®¡ç†å™¨æµ‹è¯•
- âœ… äº‹ä»¶è§¦å‘æµ‹è¯•
- âœ… å®Œæ•´å¯¹æˆ˜æµç¨‹æ¼”ç¤º

### æ–‡æ¡£
- âœ… æ ¸å¿ƒ API æ–‡æ¡£
- âœ… æ¶æ„è®¾è®¡æ–‡æ¡£
- âœ… æœ¬é›†æˆæ–‡æ¡£

---

**é¡¹ç›®çŠ¶æ€**: âœ… ç¬¬ä¸€é˜¶æ®µé›†æˆå®Œæˆ  
**æœ€åæ›´æ–°**: 2025-11-13  
**ç‰ˆæœ¬**: 1.1.0
